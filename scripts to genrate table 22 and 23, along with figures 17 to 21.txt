import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

from sklearn.svm import SVR
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import r2_score, mean_squared_error, mean_absolute_error

def mean_percentage_error(y_true, y_pred):
    y_true, y_pred = np.array(y_true), np.array(y_pred)
    return np.mean((y_true - y_pred) / y_true) * 100

def mean_absolute_percentage_error(y_true, y_pred):
    y_true, y_pred = np.array(y_true), np.array(y_pred)
    return np.mean(np.abs((y_true - y_pred) / y_true)) * 100

data = {
    "Drug": ["Apraclonidine","Betaxolol","Bimatoprost","Carteolol","Ginkgolide B","Glycerol",
             "Isosorbide","Latanoprost","Latanoprostene bunod","Levobunolol","Losartan",
             "Mannitol","Metipranolol","Netarsudil","Omidenepag isopropyl","Pilocarpine",
             "Ripasudil","Tafluprost","Timolol","Trabodenoson","Travoprost","Unoprostone"],

    "M1":[76,104,140,106,200,20,54,146,166,106,156,50,104,176,190,76,118,154,104,146,170,120],
    "M2":[87,113,155,118,279,19,65,161,181,119,185,55,116,205,218,89,142,170,115,175,189,130],
    "H":[6.866667,10.3,14.06667,9.3,12.85476,2.633333,4.6,14.3,16.8,9.333333,
         14.43333,5.133333,9.533333,15.93333,17.20476,6.966667,10.10476,14.46667,
         9.5,12.63333,15.58571,12.46667],
    "HM":[368,476,648,520,1198,84,272,680,760,522,760,240,504,856,924,372,602,736,502,728,822,548],
    "F":[194,250,338,284,640,46,142,358,398,284,390,130,272,446,488,194,318,396,272,378,444,288],
    "R":[7.164704,10.63103,14.50724,9.849155,13.83997,2.80806,4.787694,14.86308,
         17.36308,9.865992,14.70704,5.540111,10.21812,16.43989,17.8077,7.219545,
         10.51487,15.17634,9.955308,13.04171,16.46825,12.9516],
    "RR":[36.79207,50.59003,68.2868,50.33794,95.44305,9.459457,26.26206,70.78618,
          80.78618,50.43896,76.85333,23.65561,49.45232,85.88272,92.11415,37.02474,
          57.08924,73.81201,49.70691,71.32208,81.14926,58.2209],
    "SCI":[3.433333,5.15,7.033333,4.65,6.427381,1.316667,2.3,7.15,8.4,4.666667,
           7.216667,2.566667,4.766667,7.966667,8.602381,3.483333,5.052381,
           7.233333,4.75,6.316667,7.792857,6.233333],
   "GA": [15.4364,	22.35563,	30.18467,	20.89302,	33.06481,	4.711235,	10.65123,	30.9537,
          35.9537,	20.93343,	32.46879,	10.30931,	20.76657,	36.02303,	38.77348,	15.53343,
          23.19031,	31.6137,	21.06741,	29.22165,	34.30304,	26.13151],
    "ABC":[11.561,16.59163,22.23655,16.171,23.24362,3.644924,7.875634,23.16244,
           26.69797,16.13056,23.20127,8.094413,16.26971,26.39831,28.76662,
           11.41117,17.2222,24.07799,16.06161,21.36768,26.40601,19.51751],

    "BP":[395.5,448,629.8,518.6,762.4,290,372.1,583.8,658.3,464.4,682,494.9,
          458.7,711.9,709.9,431.8,497.2,552.9,487.2,691.2,584.8,562.9],
    "EV":[64.6,74.4,97.9,83.3,126.6,61.4,71.6,91.8,101.8,76.5,105.1,87.8,
          75.8,104.1,103.8,68.8,76.5,87.7,79.3,106.4,91.9,97.2],
    "FP":[193,224.7,334.7,267.4,274.3,160,178.8,188.3,351.9,234.7,366.3,292.5,
          231.2,384.3,383.1,215,254.5,288.2,248.5,371.8,307.5,308.3],
    "IR":[1.719,1.53,1.591,1.542,1.651,1.49,1.562,1.538,1.544,1.543,1.681,
          1.597,1.513,1.667,1.641,1.585,1.589,1.549,1.549,1.816,1.547,1.509],
    "MR":[59.2,88.9,122.7,81.4,94.2,20.5,32.1,123.6,136.1,82.7,118.2,38.9,
          87,135,143.9,57,84.3,121.3,82.2,87.8,127.5,106.8],
    "PSA":[62,51,90,71,149,61,59,87,142,59,93,121,87,94,128,44,71,76,
           108,160,96,95],
    "P":[23.5,35.3,48.6,32.3,37.3,8.1,12.7,49,53.9,32.8,46.9,15.4,
         34.5,53.5,57.1,22.6,33.4,48.1,32.6,34.8,50.6,42.3],
    "ST":[59.4,41.5,48,43.6,79,62,56.7,43.4,48.3,44,53.3,99.9,
          34.5,58,53,42,46.9,40.8,52.5,89.4,41.7,42.4],
    "MV":[150,288,362.8,258.6,258,71,99,395.5,430.7,262.6,312.5,114.1,
          289.5,362.6,399.2,170.2,250.1,381.5,258.5,202.5,402,357.8]
}

df = pd.DataFrame(data)

X = df.iloc[:, 1:10]      # descriptors
targets = df.columns[11:]

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

metrics = []
predicted_table = df[["Drug"]].copy()

for prop in targets:
    y = df[prop]

    model = SVR(kernel="rbf", C=100, gamma="scale", epsilon=0.1)
    model.fit(X_scaled, y)

    y_pred = model.predict(X_scaled)

    r2 = r2_score(y, y_pred)
    rmse = np.sqrt(mean_squared_error(y, y_pred))
    mae = mean_absolute_error(y, y_pred)
    mpe = mean_percentage_error(y, y_pred)
    mape = mean_absolute_percentage_error(y, y_pred)

    metrics.append([prop, r2, rmse, mae, mpe, mape])

    predicted_table[f"{prop}_Actual"] = y
    predicted_table[f"{prop}_Predicted"] = y_pred

    plt.figure(figsize=(6,4))
    plt.plot(y.values, 'o-', label="Actual")
    plt.plot(y_pred, 'x--', label="Predicted")
    plt.xlabel("Drug Index")
    plt.ylabel(prop)
    plt.title(f"SVR: Actual vs Predicted ({prop})")
    plt.legend()
    plt.grid(alpha=0.3)
    plt.tight_layout()
    plt.show()

metrics_df = pd.DataFrame(
    metrics,
    columns=["Property", "R2", "RMSE", "MAE", "MPE (%)", "MAPE (%)"]
)

metrics_df.to_csv("SVR_Error_Metrics.csv", index=False)
predicted_table.to_csv("SVR_Actual_vs_Predicted.csv", index=False)

print("SVR Error Metrics:")
print(metrics_df.round(6))
print("\nActual vs Predicted table saved.")
